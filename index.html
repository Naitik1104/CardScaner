<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CardScan — Business Card Reader</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --ink:      #0d0d0d;
  --ink2:     #1a1a1a;
  --paper:    #f7f5f2;
  --paper2:   #eeecea;
  --border:   #d8d4ce;
  --mid:      #8a8580;
  --gold:     #c8a84b;
  --gold2:    #a8891f;
  --red:      #c0392b;
  --green:    #1a7a4a;
  --radius:   4px;
  --serif:    'Playfair Display', Georgia, serif;
  --sans:     'Figtree', 'Helvetica Neue', sans-serif;
}

html, body {
  min-height: 100%;
  background: var(--paper);
  color: var(--ink);
  font-family: var(--sans);
  font-weight: 400;
  -webkit-font-smoothing: antialiased;
}

body {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
  min-height: 100vh;
}

/* ── Header ─────────────────────────────────────────────────────────── */
.site-header {
  width: 100%;
  border-bottom: 1px solid var(--border);
  background: var(--ink);
  padding: 0 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
  position: sticky;
  top: 0;
  z-index: 50;
}

.brand {
  display: flex;
  align-items: baseline;
  gap: 3px;
}

.brand-name {
  font-family: var(--serif);
  font-size: 20px;
  font-weight: 700;
  color: #fff;
  letter-spacing: -0.3px;
}

.brand-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--gold);
  margin-left: 1px;
  margin-bottom: 2px;
  flex-shrink: 0;
  display: inline-block;
}

.header-tag {
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.35);
}

/* ── Main layout ─────────────────────────────────────────────────────── */
.main {
  width: 100%;
  max-width: 520px;
  padding: 40px 20px 60px;
  flex: 1;
}

/* ── View system ─────────────────────────────────────────────────────── */
.view { display: none; }
.view.active { display: block; }

/* ── Hero block ──────────────────────────────────────────────────────── */
.hero { margin-bottom: 32px; }

.eyebrow {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.eyebrow::before {
  content: '';
  display: block;
  width: 20px;
  height: 1px;
  background: var(--gold);
}

h1 {
  font-family: var(--serif);
  font-size: clamp(30px, 7vw, 42px);
  font-weight: 800;
  line-height: 1.08;
  letter-spacing: -1px;
  color: var(--ink);
  margin-bottom: 14px;
}

.subtitle {
  font-size: 14px;
  font-weight: 400;
  color: var(--mid);
  line-height: 1.65;
  max-width: 380px;
}

/* ── Upload zone ─────────────────────────────────────────────────────── */
.upload-zone {
  position: relative;
  border: 1.5px dashed var(--border);
  border-radius: var(--radius);
  padding: 44px 24px;
  text-align: center;
  cursor: pointer;
  background: #fff;
  transition: border-color 0.2s, background 0.2s;
  margin-bottom: 16px;
}

.upload-zone:hover,
.upload-zone.drag-over {
  border-color: var(--gold);
  background: #fdf9f0;
}

.upload-zone input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
  width: 100%;
  height: 100%;
}

.upload-icon {
  width: 52px;
  height: 52px;
  border: 1.5px solid var(--border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
  color: var(--mid);
  transition: border-color 0.2s, color 0.2s;
}

.upload-zone:hover .upload-icon {
  border-color: var(--gold);
  color: var(--gold);
}

.upload-icon svg { width: 22px; height: 22px; }

.upload-title {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 5px;
  color: var(--ink);
}

.upload-hint {
  font-size: 12px;
  color: var(--mid);
}

/* ── Divider ─────────────────────────────────────────────────────────── */
.or-divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0 0 16px;
}

.or-line { flex: 1; height: 1px; background: var(--border); }
.or-text { font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--mid); }

/* ── Buttons ─────────────────────────────────────────────────────────── */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 13px 24px;
  border: none;
  border-radius: var(--radius);
  font-family: var(--sans);
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.2px;
  cursor: pointer;
  transition: all 0.15s;
  line-height: 1;
}

.btn svg { width: 17px; height: 17px; flex-shrink: 0; }

.btn-primary {
  background: var(--ink);
  color: #fff;
}
.btn-primary:hover { background: #2a2a2a; }
.btn-primary:active { transform: scale(0.99); }

.btn-gold {
  background: var(--gold);
  color: #fff;
}
.btn-gold:hover { background: var(--gold2); }

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--border);
  color: var(--ink);
}
.btn-outline:hover { border-color: var(--ink2); background: var(--paper2); }

.btn-sm {
  padding: 10px 16px;
  font-size: 13px;
}

/* ── Camera view ─────────────────────────────────────────────────────── */
.camera-wrap {
  position: relative;
  border-radius: var(--radius);
  overflow: hidden;
  background: #000;
  aspect-ratio: 4/3;
  margin-bottom: 12px;
}

#videoFeed {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.cam-overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.frame-border {
  position: absolute;
  inset: 20px;
  border: 1.5px solid rgba(200,168,75,0.6);
  border-radius: 2px;
}

.corner {
  position: absolute;
  width: 18px;
  height: 18px;
}

.c-tl { top: 20px; left: 20px; border-top: 2.5px solid var(--gold); border-left: 2.5px solid var(--gold); border-radius: 2px 0 0 0; }
.c-tr { top: 20px; right: 20px; border-top: 2.5px solid var(--gold); border-right: 2.5px solid var(--gold); border-radius: 0 2px 0 0; }
.c-bl { bottom: 20px; left: 20px; border-bottom: 2.5px solid var(--gold); border-left: 2.5px solid var(--gold); border-radius: 0 0 0 2px; }
.c-br { bottom: 20px; right: 20px; border-bottom: 2.5px solid var(--gold); border-right: 2.5px solid var(--gold); border-radius: 0 0 2px 0; }

.scan-beam {
  position: absolute;
  left: 20px; right: 20px;
  height: 1.5px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  animation: beam 2.8s ease-in-out infinite;
  top: 20px;
}

@keyframes beam {
  0%   { top: 20px; opacity: 0; }
  8%   { opacity: 1; }
  92%  { opacity: 1; }
  100% { top: calc(100% - 22px); opacity: 0; }
}

.cam-hint {
  font-size: 12px;
  color: var(--mid);
  text-align: center;
  margin-top: 8px;
  margin-bottom: 12px;
}

/* ── Loading ─────────────────────────────────────────────────────────── */
.loading-wrap {
  padding: 48px 0;
  text-align: center;
}

.spinner-ring {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: 2px solid var(--paper2);
  border-top-color: var(--gold);
  border-right-color: var(--ink);
  animation: spin 0.9s linear infinite;
  margin: 0 auto 24px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-title {
  font-family: var(--serif);
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 6px;
}

.loading-sub {
  font-size: 13px;
  color: var(--mid);
  margin-bottom: 24px;
}

.progress-track {
  height: 2px;
  background: var(--paper2);
  border-radius: 99px;
  overflow: hidden;
  margin-bottom: 10px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold), var(--ink));
  border-radius: 99px;
  transition: width 0.4s ease;
  width: 0%;
}

.progress-label {
  font-size: 12px;
  color: var(--mid);
  font-weight: 500;
}

/* ── Results ─────────────────────────────────────────────────────────── */
.result-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.result-title {
  font-family: var(--serif);
  font-size: 24px;
  font-weight: 700;
}

.conf-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 99px;
  letter-spacing: 0.3px;
}

.conf-high   { background: #e6f5ec; color: var(--green); border: 1px solid #b8dfc7; }
.conf-medium { background: #fdf6e3; color: #9a6f00; border: 1px solid #e8d49a; }
.conf-low    { background: #fdf0ee; color: var(--red);   border: 1px solid #f0c4bf; }

.snapshot-wrap {
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 20px;
  height: 150px;
  background: var(--ink2);
  position: relative;
}

.snapshot-wrap::after {
  content: '';
  position: absolute;
  inset: 0;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
  border-radius: var(--radius);
  pointer-events: none;
}

#snapshot {
  width: 100%;
  height: 150px;
  object-fit: cover;
  display: block;
}

/* ── Dividing rule ───────────────────────────────────────────────────── */
.rule {
  border: none;
  border-top: 1px solid var(--border);
  margin: 20px 0;
}

/* ── Form fields ─────────────────────────────────────────────────────── */
.fields { display: flex; flex-direction: column; gap: 0; }

.field-block {
  padding: 14px 0;
  border-bottom: 1px solid var(--paper2);
}

.field-block:first-child { padding-top: 0; }
.field-block:last-child  { border-bottom: none; }

.field-row-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0 20px;
}

.field-row-2 .field-block {
  border-bottom: none;
}

.field-row-2-wrap {
  border-bottom: 1px solid var(--paper2);
}

label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.8px;
  text-transform: uppercase;
  color: var(--mid);
  margin-bottom: 6px;
}

label svg { width: 11px; height: 11px; opacity: 0.7; }

input, textarea {
  width: 100%;
  background: transparent;
  border: none;
  outline: none;
  font-family: var(--sans);
  font-size: 14px;
  font-weight: 500;
  color: var(--ink);
  padding: 0;
  resize: vertical;
  line-height: 1.5;
}

input::placeholder, textarea::placeholder { color: #bbb; font-weight: 400; }

input:focus, textarea:focus { color: var(--ink); }

textarea { min-height: 54px; }

.website-link-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 5px;
}

.site-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 500;
  color: var(--gold2);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.15s;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.site-link:hover { border-color: var(--gold2); }
.site-link svg { width: 11px; height: 11px; flex-shrink: 0; }

/* ── Person name strip ───────────────────────────────────────────────── */
.person-strip {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--paper2);
  border-radius: var(--radius);
  margin-bottom: 20px;
}

.person-avatar {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: var(--ink);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  flex-shrink: 0;
}

.person-info { flex: 1; min-width: 0; }
.person-name { font-size: 14px; font-weight: 600; }
.person-role { font-size: 11px; color: var(--mid); }

/* ── Industry chip ───────────────────────────────────────────────────── */
.industry-chip {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.5px;
  padding: 3px 10px;
  border-radius: 99px;
  border: 1px solid var(--border);
  color: var(--mid);
  background: #fff;
}

/* ── Action row ──────────────────────────────────────────────────────── */
.action-row {
  display: flex;
  gap: 10px;
  margin-top: 24px;
}

.action-row .btn { flex: 1; }

.action-secondary { margin-top: 10px; }

/* ── Toast ───────────────────────────────────────────────────────────── */
.toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(60px);
  background: var(--ink);
  color: #fff;
  padding: 11px 20px;
  border-radius: 99px;
  font-size: 13px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
  opacity: 0;
  z-index: 999;
  white-space: nowrap;
}

.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

.toast-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

.toast.success .toast-dot { background: #4ade80; }
.toast.error   .toast-dot { background: #f87171; }

/* ── Footer rule ─────────────────────────────────────────────────────── */
.site-footer {
  width: 100%;
  border-top: 1px solid var(--border);
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.footer-note {
  font-size: 11px;
  color: var(--mid);
  letter-spacing: 0.3px;
}

.footer-badge {
  font-size: 11px;
  font-weight: 600;
  color: var(--mid);
  display: flex;
  align-items: center;
  gap: 5px;
}

.footer-badge::before {
  content: '';
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #4ade80;
}

canvas { display: none; }

@media (max-width: 480px) {
  .site-header { padding: 0 20px; }
  .main { padding: 28px 16px 48px; }
  .field-row-2 { grid-template-columns: 1fr; }
  .action-row { flex-direction: column; }
  .header-tag { display: none; }
  .site-footer { padding: 12px 20px; }
}
</style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <span class="brand-name">CardScan</span>
    <span class="brand-dot"></span>
  </div>
  <span class="header-tag">Local OCR · No Cloud</span>
</header>

<main class="main">

  <!-- ── START VIEW ─────────────────────────────────────────────── -->
  <div id="startView" class="view active">
    <div class="hero">
      <div class="eyebrow">Instant Extraction</div>
      <h1>Read any business card in seconds</h1>
      <p class="subtitle">All processing happens in your browser. No data leaves your device — works offline after first load.</p>
    </div>

    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept="image/*"/>
      <div class="upload-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </div>
      <div class="upload-title">Drop an image or click to browse</div>
      <div class="upload-hint">PNG · JPG · WEBP · Any resolution</div>
    </div>

    <div class="or-divider">
      <div class="or-line"></div>
      <div class="or-text">or</div>
      <div class="or-line"></div>
    </div>

    <button class="btn btn-primary" id="startCameraBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
        <circle cx="12" cy="13" r="4"/>
      </svg>
      Use Camera
    </button>
  </div>

  <!-- ── CAMERA VIEW ────────────────────────────────────────────── -->
  <div id="cameraView" class="view">
    <div class="eyebrow" style="margin-bottom:16px">Position card within frame</div>
    <div class="camera-wrap">
      <video id="videoFeed" playsinline autoplay muted></video>
      <div class="cam-overlay">
        <div class="frame-border"></div>
        <div class="scan-beam"></div>
        <div class="corner c-tl"></div>
        <div class="corner c-tr"></div>
        <div class="corner c-bl"></div>
        <div class="corner c-br"></div>
      </div>
    </div>
    <p class="cam-hint">Ensure even lighting · Keep card flat · Hold steady</p>
    <button class="btn btn-gold" id="captureBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 2v3m0 14v3M2 12h3m14 0h3"/>
      </svg>
      Capture
    </button>
    <div style="margin-top:10px">
      <button class="btn btn-outline" id="cancelCamBtn">Cancel</button>
    </div>
  </div>

  <!-- ── LOADING VIEW ───────────────────────────────────────────── -->
  <div id="loadingView" class="view">
    <div class="loading-wrap">
      <div class="spinner-ring"></div>
      <div class="loading-title">Reading your card</div>
      <div class="loading-sub">Local OCR processing — no upload required</div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-label" id="progressLabel">Initialising…</div>
    </div>
  </div>

  <!-- ── RESULTS VIEW ───────────────────────────────────────────── -->
  <div id="resultsView" class="view">

    <div class="result-header">
      <div class="result-title">Card Details</div>
      <div class="conf-badge" id="confBadge">—</div>
    </div>

    <div class="snapshot-wrap">
      <img id="snapshot" alt="Captured business card"/>
    </div>

    <div id="personStrip" class="person-strip" style="display:none">
      <div class="person-avatar" id="personAvatar"></div>
      <div class="person-info">
        <div class="person-name" id="personName"></div>
        <div class="person-role">Contact Person</div>
      </div>
      <div class="industry-chip" id="industryChip"></div>
    </div>

    <div class="fields" id="fieldsContainer">

      <div class="field-block">
        <label>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
          Business Name
        </label>
        <input type="text" id="fBusiness" placeholder="Company or organisation"/>
      </div>

      <div class="field-row-2-wrap">
        <div class="field-row-2">
          <div class="field-block">
            <label>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 13.5a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.59 2.68h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 10a16 16 0 0 0 6 6l.91-.91a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 21.73 17z"/></svg>
              Phone
            </label>
            <input type="text" id="fPhone" placeholder="+1 (555) 000-0000"/>
          </div>
          <div class="field-block">
            <label>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              Email
            </label>
            <input type="email" id="fEmail" placeholder="name@company.com"/>
          </div>
        </div>
      </div>

      <div class="field-block">
        <label>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Website
        </label>
        <input type="text" id="fWebsite" placeholder="https://company.com"/>
        <div class="website-link-row" id="websiteRow" style="display:none">
          <a class="site-link" id="siteLink" target="_blank" rel="noopener noreferrer">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            <span id="siteLinkLabel"></span>
          </a>
        </div>
      </div>

      <div class="field-block" style="border-bottom:none">
        <label>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Address
        </label>
        <textarea id="fAddress" placeholder="Street, City, State, ZIP" rows="3"></textarea>
      </div>

    </div>

    <hr class="rule"/>

    <div class="action-row">
      <button class="btn btn-primary" id="copyCSVBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2"/>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
        </svg>
        Copy CSV
      </button>
      <button class="btn btn-outline" id="copyJSONBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <polyline points="16 18 22 12 16 6"/>
          <polyline points="8 6 2 12 8 18"/>
        </svg>
        Copy JSON
      </button>
    </div>

    <div class="action-secondary">
      <button class="btn btn-outline" id="resetBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        Scan Another Card
      </button>
    </div>

  </div>

</main>

<footer class="site-footer">
  <span class="footer-note">All processing is local · Zero data retention</span>
  <span class="footer-badge">Offline-ready</span>
</footer>

<canvas id="canvas"></canvas>

<div class="toast" id="toast">
  <div class="toast-dot"></div>
  <span id="toastMsg"></span>
</div>

<script src="extractor.js"></script>
<script>
  const $ = id => document.getElementById(id);

  const V = {
    start:   $('startView'),
    camera:  $('cameraView'),
    loading: $('loadingView'),
    results: $('resultsView'),
  };

  let camStream = null;

  function showView(name) {
    Object.values(V).forEach(v => v.classList.remove('active'));
    V[name].classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function toast(msg, type = 'success') {
    const el = $('toast');
    $('toastMsg').textContent = msg;
    el.className = `toast ${type}`;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), 3200);
  }

  function setProgress(pct, label) {
    $('progressFill').style.width = pct + '%';
    $('progressLabel').textContent = label;
  }

  async function runOCR(imageDataUrl) {
    showView('loading');
    setProgress(4, 'Starting engine…');

    const imgEl = new Image();
    imgEl.src = imageDataUrl;
    await new Promise(r => { imgEl.onload = r; });

    const srcCanvas = document.createElement('canvas');
    srcCanvas.width = imgEl.naturalWidth;
    srcCanvas.height = imgEl.naturalHeight;
    srcCanvas.getContext('2d').drawImage(imgEl, 0, 0);

    const scaled = CardExtractor.scaleCanvas(srcCanvas, 2400);
    const processed = CardExtractor.preprocessCanvas(scaled);

    setProgress(15, 'Preprocessing image…');

    try {
      const worker = await Tesseract.createWorker('eng', 1, {
        logger: m => {
          if (m.status === 'loading tesseract core')        setProgress(20, 'Loading OCR core…');
          else if (m.status === 'loading language traineddata') setProgress(38, 'Loading language data…');
          else if (m.status === 'initializing api')         setProgress(52, 'Initialising engine…');
          else if (m.status === 'recognizing text') {
            const p = 55 + Math.round((m.progress || 0) * 38);
            setProgress(p, `Recognising text… ${Math.round((m.progress || 0) * 100)}%`);
          }
        }
      });

      await worker.setParameters({
        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
        preserve_interword_spaces: '1',
      });

      const result = await worker.recognize(processed.toDataURL('image/png'));
      await worker.terminate();

      setProgress(100, 'Complete');

      const rawText   = result.data.text;
      const ocrConf   = result.data.confidence;
      const extracted = CardExtractor.parse(rawText, ocrConf);

      populate(extracted, imageDataUrl);
      showView('results');

    } catch (err) {
      console.error(err);
      showView('start');
      toast('OCR failed: ' + err.message, 'error');
    }
  }

  function populate(d, imageUrl) {
    $('snapshot').src = imageUrl;
    $('fBusiness').value = d.businessName || '';
    $('fPhone').value    = d.phone        || '';
    $('fEmail').value    = d.email        || '';
    $('fWebsite').value  = d.website      || '';
    $('fAddress').value  = d.address      || '';

    if (d.personName) {
      const initials = d.personName.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
      $('personAvatar').textContent = initials;
      $('personName').textContent   = d.personName;
      $('industryChip').textContent = d.industryType || 'Business';
      $('personStrip').style.display = 'flex';
    } else {
      $('personStrip').style.display = 'none';
    }

    const pct = d.confidence || 0;
    const badge = $('confBadge');
    badge.textContent = pct + '% confidence';
    badge.className = 'conf-badge ' + (pct >= 72 ? 'conf-high' : pct >= 48 ? 'conf-medium' : 'conf-low');

    updateWebsiteLink();
  }

  function updateWebsiteLink() {
    const raw = $('fWebsite').value.trim();
    const row = $('websiteRow');
    if (raw && raw.length > 5) {
      const href = /^https?:\/\//i.test(raw) ? raw : 'https://' + raw.replace(/^www\./i, 'www.');
      $('siteLink').href = href;
      $('siteLinkLabel').textContent = href.replace(/^https?:\/\/(www\.)?/i, '');
      row.style.display = 'flex';
    } else {
      row.style.display = 'none';
    }
  }

  $('fWebsite').addEventListener('input', updateWebsiteLink);

  function getValues() {
    return {
      businessName: $('fBusiness').value,
      phone:        $('fPhone').value,
      email:        $('fEmail').value,
      website:      $('fWebsite').value,
      address:      $('fAddress').value.replace(/\n/g, ' '),
    };
  }

  function copyText(text, msg) {
    const fn = () => toast(msg, 'success');
    const fail = () => {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.cssText = 'position:fixed;left:-9999px;top:0';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); fn(); } catch { toast('Copy failed — please copy manually', 'error'); }
      document.body.removeChild(ta);
    };
    if (navigator.clipboard) navigator.clipboard.writeText(text).then(fn).catch(fail);
    else fail();
  }

  $('copyCSVBtn').addEventListener('click', () => {
    const v = getValues();
    const row = [v.businessName, v.phone, v.email, v.website, v.address]
      .map(s => `"${s.replace(/"/g, '""')}"`)
      .join(',');
    copyText(row, 'CSV row copied — paste directly into Google Sheets');
  });

  $('copyJSONBtn').addEventListener('click', () => {
    copyText(JSON.stringify(getValues(), null, 2), 'JSON copied to clipboard');
  });

  $('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => runOCR(ev.target.result);
    reader.readAsDataURL(file);
  });

  const zone = $('uploadZone');
  zone.addEventListener('dragover',  e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', ()  => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = ev => runOCR(ev.target.result);
      reader.readAsDataURL(file);
    }
  });

  $('startCameraBtn').addEventListener('click', async () => {
    try {
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false,
      });
      const vid = $('videoFeed');
      const settings = camStream.getVideoTracks()[0].getSettings();
      vid.style.transform = settings.facingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
      vid.srcObject = camStream;
      showView('camera');
    } catch (err) {
      toast(err.name === 'NotAllowedError' ? 'Camera access was denied' : 'No camera found on this device', 'error');
    }
  });

  $('captureBtn').addEventListener('click', () => {
    const vid = $('videoFeed');
    const cv  = $('canvas');
    cv.width  = vid.videoWidth;
    cv.height = vid.videoHeight;
    const ctx = cv.getContext('2d');
    if (vid.style.transform === 'scaleX(-1)') { ctx.translate(cv.width, 0); ctx.scale(-1, 1); }
    ctx.drawImage(vid, 0, 0);
    stopCam();
    runOCR(cv.toDataURL('image/png'));
  });

  $('cancelCamBtn').addEventListener('click', () => { stopCam(); showView('start'); });

  function stopCam() {
    if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
  }

  $('resetBtn').addEventListener('click', () => {
    $('fileInput').value = '';
    $('personStrip').style.display = 'none';
    showView('start');
  });
</script>
</body>
</html>
