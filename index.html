<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CardScan — Instant Business Card Reader</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #16161f;
    --border: rgba(255,255,255,0.07);
    --accent: #c8ff00;
    --accent2: #00e5ff;
    --text: #f0f0f8;
    --muted: #6b6b7e;
    --success: #00e5a0;
    --error: #ff4d6d;
    --radius: 16px;
    --mono: 'DM Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  body {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 20% 10%, rgba(200,255,0,0.06) 0%, transparent 60%),
      radial-gradient(ellipse 50% 50% at 80% 90%, rgba(0,229,255,0.05) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .grain {
    position: fixed;
    inset: 0;
    opacity: 0.025;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    background-size: 150px;
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 520px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 32px;
  }

  .logo-mark {
    width: 36px;
    height: 36px;
    background: var(--accent);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .logo-mark svg { width: 20px; height: 20px; }

  .logo-text {
    font-size: 22px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .logo-text span { color: var(--accent); }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 40px 80px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.04);
  }

  .card-inner { padding: 28px; }

  .view { display: none; }
  .view.active { display: block; }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
  }

  .tag-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  h1 {
    font-size: clamp(26px, 5vw, 36px);
    font-weight: 800;
    line-height: 1.1;
    letter-spacing: -1px;
    margin-bottom: 12px;
  }

  h1 em {
    font-style: normal;
    color: var(--accent);
  }

  .subtitle {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 28px;
  }

  .upload-zone {
    border: 2px dashed rgba(255,255,255,0.1);
    border-radius: var(--radius);
    padding: 40px 24px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    background: var(--surface2);
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent);
    background: rgba(200,255,0,0.03);
  }

  .upload-zone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon {
    width: 48px;
    height: 48px;
    background: rgba(200,255,0,0.1);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
  }

  .upload-icon svg { width: 24px; height: 24px; color: var(--accent); }

  .upload-title {
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 6px;
  }

  .upload-hint {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
  }

  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
  }

  .divider-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .divider-text {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 14px 24px;
    border: none;
    border-radius: 12px;
    font-family: var(--sans);
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: -0.2px;
  }

  .btn-primary {
    background: var(--accent);
    color: #0a0a0f;
  }

  .btn-primary:hover { background: #d4ff26; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(200,255,0,0.25); }
  .btn-primary:active { transform: translateY(0); }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
  }

  .btn-ghost:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.03); }

  .btn-accent2 {
    background: transparent;
    border: 1px solid var(--accent2);
    color: var(--accent2);
  }

  .btn-accent2:hover { background: rgba(0,229,255,0.08); }

  .btn svg { width: 18px; height: 18px; flex-shrink: 0; }

  .camera-container {
    position: relative;
    border-radius: var(--radius);
    overflow: hidden;
    background: #000;
    aspect-ratio: 4/3;
    margin-bottom: 16px;
  }

  #videoFeed {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .camera-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .scan-frame {
    position: absolute;
    inset: 16px;
    border: 2px solid rgba(200,255,0,0.5);
    border-radius: 8px;
    animation: scan-glow 2s ease-in-out infinite alternate;
  }

  @keyframes scan-glow {
    from { box-shadow: inset 0 0 20px rgba(200,255,0,0.05), 0 0 0 rgba(200,255,0,0); }
    to { box-shadow: inset 0 0 30px rgba(200,255,0,0.12), 0 0 20px rgba(200,255,0,0.1); }
  }

  .scan-line {
    position: absolute;
    left: 16px;
    right: 16px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scan-move 2.5s linear infinite;
    top: 16px;
  }

  @keyframes scan-move {
    0% { top: 16px; opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { top: calc(100% - 18px); opacity: 0; }
  }

  .corner { position: absolute; width: 16px; height: 16px; }
  .corner-tl { top: 16px; left: 16px; border-top: 3px solid var(--accent); border-left: 3px solid var(--accent); border-radius: 2px 0 0 0; }
  .corner-tr { top: 16px; right: 16px; border-top: 3px solid var(--accent); border-right: 3px solid var(--accent); border-radius: 0 2px 0 0; }
  .corner-bl { bottom: 16px; left: 16px; border-bottom: 3px solid var(--accent); border-left: 3px solid var(--accent); border-radius: 0 0 0 2px; }
  .corner-br { bottom: 16px; right: 16px; border-bottom: 3px solid var(--accent); border-right: 3px solid var(--accent); border-radius: 0 0 2px 0; }

  .progress-bar {
    height: 3px;
    background: var(--surface2);
    border-radius: 99px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 99px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .progress-label {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .snapshot-wrap {
    border-radius: var(--radius);
    overflow: hidden;
    background: #000;
    margin-bottom: 20px;
    max-height: 160px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #snapshot {
    width: 100%;
    height: 160px;
    object-fit: cover;
    display: block;
  }

  .fields-grid {
    display: grid;
    gap: 12px;
    margin-bottom: 20px;
  }

  .field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .field.full { grid-column: 1 / -1; }

  label {
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  label svg { width: 12px; height: 12px; opacity: 0.6; }

  input, textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    padding: 10px 12px;
    width: 100%;
    transition: border-color 0.15s;
    outline: none;
    resize: vertical;
  }

  input:focus, textarea:focus { border-color: rgba(200,255,0,0.4); background: rgba(200,255,0,0.02); }

  textarea { min-height: 72px; }

  .website-preview {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
  }

  .website-link {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent2);
    text-decoration: none;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .website-link:hover { text-decoration: underline; }
  .website-link svg { width: 12px; height: 12px; flex-shrink: 0; }

  .industry-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-family: var(--mono);
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 99px;
    background: rgba(0,229,255,0.1);
    border: 1px solid rgba(0,229,255,0.2);
    color: var(--accent2);
    margin-top: 4px;
  }

  .actions { display: flex; flex-direction: column; gap: 10px; }

  .copy-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 20px;
    font-family: var(--mono);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
    opacity: 0;
    z-index: 100;
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  .toast-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .toast.success .toast-icon { background: rgba(0,229,160,0.2); color: var(--success); }
  .toast.error .toast-icon { background: rgba(255,77,109,0.2); color: var(--error); }

  .confidence-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    background: var(--surface2);
    border-radius: 10px;
    border: 1px solid var(--border);
    margin-bottom: 16px;
  }

  .confidence-label {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.5px;
  }

  .confidence-value {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 500;
  }

  .confidence-high { color: var(--success); }
  .confidence-medium { color: var(--accent); }
  .confidence-low { color: var(--error); }

  #canvas { display: none; }
  #fileInput { display: none; }

  .loading-state {
    text-align: center;
    padding: 32px 0;
  }

  .loading-spinner {
    width: 48px;
    height: 48px;
    margin: 0 auto 20px;
    position: relative;
  }

  .loading-spinner::before, .loading-spinner::after {
    content: '';
    position: absolute;
    border-radius: 50%;
    border: 2px solid transparent;
  }

  .loading-spinner::before {
    inset: 0;
    border-top-color: var(--accent);
    animation: spin 0.8s linear infinite;
  }

  .loading-spinner::after {
    inset: 6px;
    border-top-color: var(--accent2);
    animation: spin 1.2s linear infinite reverse;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-title {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 6px;
  }

  .loading-subtitle {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
  }

  .ocr-status {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    margin-top: 8px;
    height: 16px;
  }

  @media (max-width: 480px) {
    .field-row { grid-template-columns: 1fr; }
    .copy-options { grid-template-columns: 1fr; }
    .card-inner { padding: 20px; }
  }
</style>
</head>
<body>
<div class="grain"></div>
<div class="app">
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:#0a0a0f">
        <rect x="2" y="5" width="20" height="14" rx="2"/>
        <line x1="2" y1="10" x2="22" y2="10"/>
      </svg>
    </div>
    <div class="logo-text">Card<span>Scan</span></div>
  </div>

  <div class="card">
    <div class="card-inner">

      <!-- START VIEW -->
      <div id="startView" class="view active">
        <h1>Scan any<br/><em>business card</em><br/>instantly</h1>
        <p class="subtitle">Local OCR + smart extraction. No cloud, no API keys, works offline after load.</p>

        <div class="upload-zone" id="uploadZone">
          <input type="file" id="fileInput" accept="image/*" capture="environment"/>
          <div class="upload-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
          </div>
          <div class="upload-title">Drop image or click to upload</div>
          <div class="upload-hint">PNG, JPG, WEBP · Any resolution</div>
        </div>

        <div class="divider">
          <div class="divider-line"></div>
          <div class="divider-text">or</div>
          <div class="divider-line"></div>
        </div>

        <button class="btn btn-primary" id="startCameraBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
          Use Camera
        </button>
      </div>

      <!-- CAMERA VIEW -->
      <div id="cameraView" class="view">
        <div class="tag"><div class="tag-dot"></div> Camera active</div>
        <div class="camera-container">
          <video id="videoFeed" playsinline autoplay muted></video>
          <div class="camera-overlay">
            <div class="scan-frame"></div>
            <div class="scan-line"></div>
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
          </div>
        </div>
        <button class="btn btn-primary" id="captureBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v3m0 16v3M1 12h3m16 0h3"/>
          </svg>
          Capture Card
        </button>
        <div style="margin-top:10px">
          <button class="btn btn-ghost" id="cancelCameraBtn" style="padding:10px">
            Cancel
          </button>
        </div>
      </div>

      <!-- LOADING VIEW -->
      <div id="loadingView" class="view">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <div class="loading-title">Reading Card…</div>
          <div class="loading-subtitle">Local OCR processing</div>
          <div class="progress-bar" style="margin-top:20px">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="ocr-status" id="ocrStatus">Initializing…</div>
        </div>
      </div>

      <!-- RESULTS VIEW -->
      <div id="resultsView" class="view">
        <div class="tag"><div class="tag-dot" style="background:var(--success)"></div> Extraction complete</div>

        <div class="snapshot-wrap">
          <img id="snapshot" alt="Captured card"/>
        </div>

        <div class="confidence-row" id="confidenceRow">
          <span class="confidence-label">Extraction confidence</span>
          <span class="confidence-value" id="confidenceVal">—</span>
        </div>

        <div class="fields-grid">
          <div class="field-row">
            <div class="field">
              <label>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
                Business
              </label>
              <input type="text" id="fBusinessName" placeholder="Company name"/>
            </div>
            <div class="field">
              <label>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                Industry
              </label>
              <input type="text" id="fIndustry" placeholder="Sector"/>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 13.5 19.79 19.79 0 0 1 1.61 4.87 2 2 0 0 1 3.59 2.68h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 10a16 16 0 0 0 6 6l.91-.91a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 21.73 17.33z"/></svg>
                Phone
              </label>
              <input type="text" id="fPhone" placeholder="Phone number"/>
            </div>
            <div class="field">
              <label>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                Email
              </label>
              <input type="email" id="fEmail" placeholder="Email address"/>
            </div>
          </div>

          <div class="field full">
            <label>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
              Website
            </label>
            <input type="text" id="fWebsite" placeholder="https://..."/>
            <div class="website-preview" id="websitePreview" style="display:none">
              <a class="website-link" id="websiteLink" target="_blank" rel="noopener">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                <span id="websiteLinkText"></span>
              </a>
            </div>
          </div>

          <div class="field full">
            <label>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
              Address
            </label>
            <textarea id="fAddress" placeholder="Physical address" rows="3"></textarea>
          </div>
        </div>

        <div class="actions">
          <div class="copy-options">
            <button class="btn btn-primary" id="copyCSVBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              Copy CSV
            </button>
            <button class="btn btn-accent2" id="copyJSONBtn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
              Copy JSON
            </button>
          </div>
          <button class="btn btn-ghost" id="resetBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Scan Another
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<canvas id="canvas"></canvas>

<div class="toast" id="toast">
  <div class="toast-icon" id="toastIcon">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="12" height="12"><polyline points="20 6 9 17 4 12"/></svg>
  </div>
  <span id="toastMsg"></span>
</div>

<script src="extractor.js"></script>
<script>
  const $ = id => document.getElementById(id);

  const views = { start: $('startView'), camera: $('cameraView'), loading: $('loadingView'), results: $('resultsView') };
  let stream = null;

  function showView(name) {
    Object.values(views).forEach(v => v.classList.remove('active'));
    views[name].classList.add('active');
  }

  function toast(msg, type = 'success') {
    const el = $('toast');
    $('toastMsg').textContent = msg;
    el.className = `toast ${type}`;
    $('toastIcon').innerHTML = type === 'success'
      ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="12" height="12"><polyline points="20 6 9 17 4 12"/></svg>'
      : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="12" height="12"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), 3000);
  }

  function setProgress(pct, label) {
    $('progressFill').style.width = pct + '%';
    $('ocrStatus').textContent = label;
  }

  async function runOCR(imageDataUrl) {
    showView('loading');
    setProgress(5, 'Loading OCR engine…');

    try {
      const worker = await Tesseract.createWorker('eng', 1, {
        logger: m => {
          if (m.status === 'loading tesseract core') setProgress(10, 'Loading core…');
          else if (m.status === 'loading language traineddata') setProgress(30, 'Loading language data…');
          else if (m.status === 'initializing api') setProgress(50, 'Initializing…');
          else if (m.status === 'recognizing text') {
            const p = Math.round(50 + (m.progress || 0) * 45);
            setProgress(p, `Recognizing text… ${Math.round((m.progress || 0) * 100)}%`);
          }
        }
      });

      const result = await worker.recognize(imageDataUrl);
      await worker.terminate();

      setProgress(100, 'Done');

      const rawText = result.data.text;
      const confidence = result.data.confidence;

      const extracted = BusinessCardExtractor.parse(rawText);

      populateResults(extracted, imageDataUrl, confidence);
      showView('results');

    } catch (err) {
      console.error(err);
      showView('start');
      toast('OCR failed: ' + err.message, 'error');
    }
  }

  function populateResults(data, imageUrl, confidence) {
    $('snapshot').src = imageUrl;
    $('fBusinessName').value = data.businessName || '';
    $('fIndustry').value = data.industryType || '';
    $('fPhone').value = data.phone || '';
    $('fEmail').value = data.email || '';
    $('fWebsite').value = data.website || '';
    $('fAddress').value = data.address || '';

    const pct = Math.round(confidence || 0);
    const valEl = $('confidenceVal');
    valEl.textContent = pct + '%';
    valEl.className = 'confidence-value ' + (pct >= 75 ? 'confidence-high' : pct >= 50 ? 'confidence-medium' : 'confidence-low');

    updateWebsiteLink();
  }

  function updateWebsiteLink() {
    const url = $('fWebsite').value.trim();
    const preview = $('websitePreview');
    if (url && url.length > 4) {
      const href = /^https?:\/\//i.test(url) ? url : 'https://' + url.replace(/^www\./i, 'www.');
      $('websiteLink').href = href;
      $('websiteLinkText').textContent = href.replace(/^https?:\/\//i, '');
      preview.style.display = 'flex';
    } else {
      preview.style.display = 'none';
    }
  }

  $('fWebsite').addEventListener('input', updateWebsiteLink);

  function getFormData() {
    return {
      businessName: $('fBusinessName').value,
      industryType: $('fIndustry').value,
      phone: $('fPhone').value,
      email: $('fEmail').value,
      website: $('fWebsite').value,
      address: $('fAddress').value.replace(/\n/g, ' '),
    };
  }

  $('copyCSVBtn').addEventListener('click', () => {
    const d = getFormData();
    const row = [d.businessName, d.industryType, d.phone, d.email, d.website, d.address]
      .map(v => `"${v.replace(/"/g, '""')}"`)
      .join(',');
    copyText(row, 'CSV row copied — paste into Google Sheets');
  });

  $('copyJSONBtn').addEventListener('click', () => {
    copyText(JSON.stringify(getFormData(), null, 2), 'JSON copied to clipboard');
  });

  function copyText(text, msg) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => toast(msg)).catch(() => fallbackCopy(text, msg));
    } else {
      fallbackCopy(text, msg);
    }
  }

  function fallbackCopy(text, msg) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;left:-9999px;top:0';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); toast(msg); }
    catch { toast('Copy failed — please copy manually', 'error'); }
    document.body.removeChild(ta);
  }

  $('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => runOCR(ev.target.result);
    reader.readAsDataURL(file);
  });

  const uploadZone = $('uploadZone');
  uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
  uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
  uploadZone.addEventListener('drop', e => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = ev => runOCR(ev.target.result);
      reader.readAsDataURL(file);
    }
  });

  $('startCameraBtn').addEventListener('click', async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false });
      const video = $('videoFeed');
      const settings = stream.getVideoTracks()[0].getSettings();
      video.style.transform = settings.facingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
      video.srcObject = stream;
      showView('camera');
    } catch (err) {
      toast(err.name === 'NotAllowedError' ? 'Camera access denied' : 'No camera found', 'error');
    }
  });

  $('captureBtn').addEventListener('click', () => {
    const video = $('videoFeed');
    const canvas = $('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    if (video.style.transform === 'scaleX(-1)') {
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
    }
    ctx.drawImage(video, 0, 0);
    stopCamera();
    runOCR(canvas.toDataURL('image/png'));
  });

  $('cancelCameraBtn').addEventListener('click', () => { stopCamera(); showView('start'); });

  function stopCamera() {
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  }

  $('resetBtn').addEventListener('click', () => {
    $('fileInput').value = '';
    showView('start');
  });

  if ('serviceWorker' in navigator) {
    const SW_URL = URL.createObjectURL(new Blob([`
      self.addEventListener('fetch', e => e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request).then(res => {
          if (!res || res.status !== 200) return res;
          const clone = res.clone();
          caches.open('cardscan-v1').then(c => c.put(e.request, clone));
          return res;
        }))
      ));
    `], { type: 'application/javascript' }));
    navigator.serviceWorker.register(SW_URL).catch(() => {});
  }
</script>
</body>
</html>
